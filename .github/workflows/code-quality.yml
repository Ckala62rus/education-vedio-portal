name: Code Quality Checks

on:
  pull_request:
    branches: [ main, dev ]
    paths:
      - 'backend/**'
      - '.github/workflows/**'

jobs:
  code_quality:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv

    - name: Cache Composer packages
      uses: actions/cache@v4
      with:
        path: backend/vendor
        key: ${{ runner.os }}-php-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-composer-

    - name: Install Composer dependencies
      working-directory: ./backend
      run: composer install --no-progress --prefer-dist --optimize-autoloader

    - name: Check PHP syntax
      working-directory: ./backend
      run: |
        echo "ðŸ” Checking PHP syntax..."
        SYNTAX_ERRORS=$(find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \; | grep -v "No syntax errors" || true)
        if [ -n "$SYNTAX_ERRORS" ]; then
          echo "âŒ PHP syntax errors found:"
          echo "$SYNTAX_ERRORS"
          exit 1
        else
          echo "âœ… All PHP files have correct syntax!"
        fi

    - name: Run PHP CS Fixer (Check only)
      working-directory: ./backend
      run: |
        if [ -f "vendor/bin/php-cs-fixer" ]; then
          vendor/bin/php-cs-fixer fix --dry-run --diff --verbose --config=.php-cs-fixer.php
        else
          echo "âš ï¸ PHP CS Fixer not found. Install it with: composer require --dev friendsofphp/php-cs-fixer"
        fi
      continue-on-error: true

    - name: Run PHPStan
      working-directory: ./backend
      run: |
        if [ -f "vendor/bin/phpstan" ]; then
          vendor/bin/phpstan analyse --memory-limit=2G --error-format=github
        else
          echo "âš ï¸ PHPStan not found. Install it with: composer require --dev phpstan/phpstan"
        fi
      continue-on-error: true

    - name: Run Psalm
      working-directory: ./backend
      run: |
        if [ -f "vendor/bin/psalm" ]; then
          vendor/bin/psalm --output-format=github --show-info=false
        else
          echo "âš ï¸ Psalm not found. Install it with: composer require --dev vimeo/psalm"
        fi
      continue-on-error: true

    - name: Security audit with Composer
      working-directory: ./backend
      run: composer audit --no-dev
      continue-on-error: true

    - name: Run PHPUnit (Quick unit tests)
      working-directory: ./backend
      run: |
        # Create minimal .env for Laravel bootstrap
        echo "APP_NAME=TestApp" > .env
        echo "APP_ENV=testing" >> .env
        echo "APP_KEY=base64:$(openssl rand -base64 32)" >> .env
        echo "APP_DEBUG=true" >> .env
        echo "APP_URL=http://localhost" >> .env
        
        # Unit tests use phpunit.xml configuration for database and other settings
        # No database migrations needed for pure unit tests
        php vendor/bin/phpunit --testsuite=Unit --stop-on-failure

    - name: Check Laravel best practices
      working-directory: ./backend
      run: |
        echo "ðŸ” Checking Laravel best practices..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ env() Ð²Ð½Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð¾Ð² (Ð² app/, routes/, etc.)
        ENV_VIOLATIONS=$(find app/ routes/ -name "*.php" -exec grep -l "env(" {} \; 2>/dev/null || true)
        if [ -n "$ENV_VIOLATIONS" ]; then
          echo "âŒ Found env() calls outside config files. Use config() instead in:"
          echo "$ENV_VIOLATIONS"
          exit 1
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° debug Ñ€ÐµÐ¶Ð¸Ð¼ Ð² Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐµÐ½Ðµ
        if grep -r "APP_DEBUG=true" .env.example 2>/dev/null; then
          echo "âš ï¸ Warning: APP_DEBUG is set to true in .env.example"
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ .env Ð² git
        if git ls-files | grep -q "^\.env$"; then
          echo "âŒ .env file should not be committed to git"
          exit 1
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ DB::raw Ð±ÐµÐ· Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÐ¸ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð²
        RAW_SQL_ISSUES=$(grep -r "DB::raw\|->raw(" app/ 2>/dev/null | grep -v "DB::raw('COUNT\|DB::raw('SUM\|DB::raw('AVG\|DB::raw('MAX\|DB::raw('MIN" || true)
        if [ -n "$RAW_SQL_ISSUES" ]; then
          echo "âš ï¸ Found raw SQL queries. Ensure they are properly sanitized:"
          echo "$RAW_SQL_ISSUES"
        fi
        
        echo "âœ… Laravel best practices check passed!"

    - name: Check for common security issues
      working-directory: ./backend
      run: |
        echo "ðŸ”’ Checking for security issues..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° eval usage
        EVAL_USAGE=$(grep -r "eval(" app/ 2>/dev/null || true)
        if [ -n "$EVAL_USAGE" ]; then
          echo "âŒ Found eval() usage. This is dangerous!"
          echo "$EVAL_USAGE"
          exit 1
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð¼Ð°ÑÑÐ¾Ð²Ð¾Ðµ Ð¿Ñ€Ð¸ÑÐ²Ð°Ð¸Ð²Ð°Ð½Ð¸Ðµ
        MASS_ASSIGNMENT=$(grep -r "fillable.*=.*\[\]" app/Models/ 2>/dev/null || true)
        if [ -n "$MASS_ASSIGNMENT" ]; then
          echo "âš ï¸ Found empty fillable arrays. This might allow mass assignment:"
          echo "$MASS_ASSIGNMENT"
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð½ÐµÐ±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸
        UNSAFE_FUNCTIONS=$(grep -r "shell_exec\|exec\|system\|passthru" app/ 2>/dev/null || true)
        if [ -n "$UNSAFE_FUNCTIONS" ]; then
          echo "âš ï¸ Found potentially unsafe functions:"
          echo "$UNSAFE_FUNCTIONS"
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ñ…Ð°Ñ€Ð´ÐºÐ¾Ð´ ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²
        HARDCODED_SECRETS=$(grep -r "password.*=.*['\"][^'\"]*['\"]" app/ 2>/dev/null | grep -v "bcrypt\|Hash::" || true)
        if [ -n "$HARDCODED_SECRETS" ]; then
          echo "âš ï¸ Found potentially hardcoded passwords:"
          echo "$HARDCODED_SECRETS"
        fi
        
        echo "âœ… Security check completed!"

    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('Code Quality Report')
          );
          
          const body = `## ðŸ” Code Quality Report
          
          âœ… **PHP Syntax Check**: Passed
          âœ… **Security Audit**: Completed
          âœ… **Laravel Best Practices**: Verified
          âœ… **Unit Tests**: Quick validation passed
          
          ðŸ“Š **Static Analysis**: Check the action logs for detailed results
          
          > This is an automated check. For full test results, see the "Laravel Tests" workflow.`;
          
          if (botComment) {
            github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body
            });
          } else {
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
          } 